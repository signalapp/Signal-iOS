name: SWORDCOMM Build

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  verify:
    name: Verify Structure
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check SWORDCOMM exists
      run: |
        if [ ! -d "SWORDCOMM" ]; then
          echo "âŒ SWORDCOMM directory not found"
          exit 1
        fi
        echo "âœ… SWORDCOMM directory exists"

    - name: Check key files
      run: |
        echo "Checking essential files..."

        FILES=(
          "SWORDCOMM/Scripts/build_liboqs.sh"
          "SWORDCOMM/Scripts/integrate_swordcomm.sh"
          "SWORDCOMM/PROJECT_SUMMARY.md"
          "DEPLOYMENT_STATUS.md"
        )

        for file in "${FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done

    - name: Count source files
      run: |
        echo "Source code statistics:"
        find SWORDCOMM -name "*.swift" -o -name "*.cpp" -o -name "*.h" | wc -l
        echo "âœ… Structure verification complete"

  create-package:
    name: Create Source Package
    runs-on: ubuntu-latest
    needs: verify

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Create package
      run: |
        mkdir -p package
        cp -R SWORDCOMM package/
        cp DEPLOYMENT_STATUS.md package/
        cp README.md package/ 2>/dev/null || echo "No README"

        cat > package/BUILD_INFO.txt << 'EOF'
        SWORDCOMM iOS Port - Source Package

        This package contains complete source code for SWORDCOMM.

        To build:
        1. On macOS: ./SWORDCOMM/Scripts/build_liboqs.sh --minimal
        2. Convert model: python3 SWORDCOMM/Scripts/convert_translation_model.py --quantize
        3. Integrate: ./SWORDCOMM/Scripts/integrate_swordcomm.sh

        See DEPLOYMENT_STATUS.md for complete instructions.
        EOF

        tar -czf swordcomm-source.tar.gz package/
        ls -lh swordcomm-source.tar.gz

    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: swordcomm-source
        path: swordcomm-source.tar.gz
        retention-days: 30

  build-attempt:
    name: Try Building Frameworks
    runs-on: macos-13
    needs: verify
    continue-on-error: true

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install CMake
      run: brew install cmake

    - name: Try building liboqs
      run: |
        cd SWORDCOMM
        chmod +x Scripts/build_liboqs.sh

        echo "Attempting liboqs build (may fail - this is OK)..."
        if timeout 600 ./Scripts/build_liboqs.sh --minimal --clean 2>&1 | tee build.log; then
          echo "âœ… liboqs built successfully"
        else
          echo "âš ï¸ liboqs build failed (expected on CI)"
          echo "Developers should build locally on macOS"
        fi
      continue-on-error: true

    - name: Check if built
      run: |
        if [ -d "SWORDCOMM/Frameworks/liboqs.xcframework" ]; then
          echo "âœ… liboqs.xcframework exists"
          du -sh SWORDCOMM/Frameworks/liboqs.xcframework

          # Upload if it exists
          tar -czf liboqs.tar.gz SWORDCOMM/Frameworks/liboqs.xcframework
        else
          echo "âš ï¸ liboqs not built - developers can build locally"
          # Create empty marker file so upload doesn't fail
          mkdir -p output
          echo "Build on macOS with: ./SWORDCOMM/Scripts/build_liboqs.sh --minimal" > output/BUILD_LOCALLY.txt
          tar -czf liboqs.tar.gz output/
        fi

    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: liboqs-build-result
        path: liboqs.tar.gz
        retention-days: 7

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [verify, create-package, build-attempt]
    if: always()

    steps:
    - name: Print results
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "SWORDCOMM Build Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Verify: ${{ needs.verify.result }}"
        echo "Package: ${{ needs.create-package.result }}"
        echo "Build Attempt: ${{ needs.build-attempt.result }}"
        echo ""
        echo "âœ… Artifacts Available:"
        echo "  - swordcomm-source (complete source code)"
        echo "  - liboqs-build-result (may contain pre-built framework)"
        echo ""
        echo "ğŸ“ Next Steps:"
        echo "  1. Download swordcomm-source artifact"
        echo "  2. Build frameworks on macOS"
        echo "  3. Follow DEPLOYMENT_STATUS.md"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
