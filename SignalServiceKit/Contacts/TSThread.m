//
// Copyright 2017 Signal Messenger, LLC
// SPDX-License-Identifier: AGPL-3.0-only
//

#import "TSThread.h"
#import "OWSDisappearingMessagesConfiguration.h"
#import "OWSReadTracking.h"
#import "TSIncomingMessage.h"
#import "TSInfoMessage.h"
#import "TSInteraction.h"
#import "TSInvalidIdentityKeyReceivingErrorMessage.h"
#import "TSOutgoingMessage.h"
#import <SignalServiceKit/SignalServiceKit-Swift.h>

@import Intents;

NS_ASSUME_NONNULL_BEGIN

@interface TSThread ()

@property (nonatomic, nullable) NSDate *creationDate;
@property (nonatomic) BOOL isArchivedObsolete;
@property (nonatomic) BOOL isMarkedUnreadObsolete;

@property (atomic) uint64_t mutedUntilTimestampObsolete;

@property (nonatomic, nullable) NSDate *mutedUntilDateObsolete;
@property (nonatomic) uint64_t lastVisibleSortIdObsolete;
@property (nonatomic) double lastVisibleSortIdOnScreenPercentageObsolete;

@end

#pragma mark -

@implementation TSThread

- (instancetype)initWithUniqueId:(NSString *)uniqueId
{
    self = [super initWithUniqueId:uniqueId];

    if (self) {
        _creationDate = [NSDate date];
        _messageDraft = nil;
        _conversationColorNameObsolete = @"Obsolete";
    }

    return self;
}

// --- CODE GENERATION MARKER

// This snippet is generated by /Scripts/sds_codegen/sds_generate.py. Do not manually edit it, instead run
// `sds_codegen.sh`.

// clang-format off

- (instancetype)initWithGrdbId:(int64_t)grdbId
                      uniqueId:(NSString *)uniqueId
   conversationColorNameObsolete:(NSString *)conversationColorNameObsolete
                    creationDate:(nullable NSDate *)creationDate
             editTargetTimestamp:(nullable NSNumber *)editTargetTimestamp
              isArchivedObsolete:(BOOL)isArchivedObsolete
          isMarkedUnreadObsolete:(BOOL)isMarkedUnreadObsolete
       lastDraftInteractionRowId:(uint64_t)lastDraftInteractionRowId
        lastDraftUpdateTimestamp:(uint64_t)lastDraftUpdateTimestamp
            lastInteractionRowId:(uint64_t)lastInteractionRowId
          lastSentStoryTimestamp:(nullable NSNumber *)lastSentStoryTimestamp
       lastVisibleSortIdObsolete:(uint64_t)lastVisibleSortIdObsolete
lastVisibleSortIdOnScreenPercentageObsolete:(double)lastVisibleSortIdOnScreenPercentageObsolete
         mentionNotificationMode:(TSThreadMentionNotificationMode)mentionNotificationMode
                    messageDraft:(nullable NSString *)messageDraft
          messageDraftBodyRanges:(nullable MessageBodyRanges *)messageDraftBodyRanges
          mutedUntilDateObsolete:(nullable NSDate *)mutedUntilDateObsolete
     mutedUntilTimestampObsolete:(uint64_t)mutedUntilTimestampObsolete
           shouldThreadBeVisible:(BOOL)shouldThreadBeVisible
                   storyViewMode:(TSThreadStoryViewMode)storyViewMode
{
    self = [super initWithGrdbId:grdbId
                        uniqueId:uniqueId];

    if (!self) {
        return self;
    }

    _conversationColorNameObsolete = conversationColorNameObsolete;
    _creationDate = creationDate;
    _editTargetTimestamp = editTargetTimestamp;
    _isArchivedObsolete = isArchivedObsolete;
    _isMarkedUnreadObsolete = isMarkedUnreadObsolete;
    _lastDraftInteractionRowId = lastDraftInteractionRowId;
    _lastDraftUpdateTimestamp = lastDraftUpdateTimestamp;
    _lastInteractionRowId = lastInteractionRowId;
    _lastSentStoryTimestamp = lastSentStoryTimestamp;
    _lastVisibleSortIdObsolete = lastVisibleSortIdObsolete;
    _lastVisibleSortIdOnScreenPercentageObsolete = lastVisibleSortIdOnScreenPercentageObsolete;
    _mentionNotificationMode = mentionNotificationMode;
    _messageDraft = messageDraft;
    _messageDraftBodyRanges = messageDraftBodyRanges;
    _mutedUntilDateObsolete = mutedUntilDateObsolete;
    _mutedUntilTimestampObsolete = mutedUntilTimestampObsolete;
    _shouldThreadBeVisible = shouldThreadBeVisible;
    _storyViewMode = storyViewMode;

    return self;
}

// clang-format on

// --- CODE GENERATION MARKER

- (void)encodeWithCoder:(NSCoder *)coder
{
    [self encodeIdsWithCoder:coder];
    NSString *conversationColorNameObsolete = self.conversationColorNameObsolete;
    if (conversationColorNameObsolete != nil) {
        [coder encodeObject:conversationColorNameObsolete forKey:@"conversationColorNameObsolete"];
    }
    NSDate *creationDate = self.creationDate;
    if (creationDate != nil) {
        [coder encodeObject:creationDate forKey:@"creationDate"];
    }
    NSNumber *editTargetTimestamp = self.editTargetTimestamp;
    if (editTargetTimestamp != nil) {
        [coder encodeObject:editTargetTimestamp forKey:@"editTargetTimestamp"];
    }
    [coder encodeObject:[self valueForKey:@"isArchivedByLegacyTimestampForSorting"]
                 forKey:@"isArchivedByLegacyTimestampForSorting"];
    [coder encodeObject:[self valueForKey:@"isArchivedObsolete"] forKey:@"isArchivedObsolete"];
    [coder encodeObject:[self valueForKey:@"isMarkedUnreadObsolete"] forKey:@"isMarkedUnreadObsolete"];
    [coder encodeObject:[self valueForKey:@"lastDraftInteractionRowId"] forKey:@"lastDraftInteractionRowId"];
    [coder encodeObject:[self valueForKey:@"lastDraftUpdateTimestamp"] forKey:@"lastDraftUpdateTimestamp"];
    [coder encodeObject:[self valueForKey:@"lastInteractionRowId"] forKey:@"lastInteractionRowId"];
    NSNumber *lastSentStoryTimestamp = self.lastSentStoryTimestamp;
    if (lastSentStoryTimestamp != nil) {
        [coder encodeObject:lastSentStoryTimestamp forKey:@"lastSentStoryTimestamp"];
    }
    [coder encodeObject:[self valueForKey:@"lastVisibleSortIdObsolete"] forKey:@"lastVisibleSortIdObsolete"];
    [coder encodeObject:[self valueForKey:@"lastVisibleSortIdOnScreenPercentageObsolete"]
                 forKey:@"lastVisibleSortIdOnScreenPercentageObsolete"];
    [coder encodeObject:[self valueForKey:@"mentionNotificationMode"] forKey:@"mentionNotificationMode"];
    NSString *messageDraft = self.messageDraft;
    if (messageDraft != nil) {
        [coder encodeObject:messageDraft forKey:@"messageDraft"];
    }
    MessageBodyRanges *messageDraftBodyRanges = self.messageDraftBodyRanges;
    if (messageDraftBodyRanges != nil) {
        [coder encodeObject:messageDraftBodyRanges forKey:@"messageDraftBodyRanges"];
    }
    NSDate *mutedUntilDateObsolete = self.mutedUntilDateObsolete;
    if (mutedUntilDateObsolete != nil) {
        [coder encodeObject:mutedUntilDateObsolete forKey:@"mutedUntilDateObsolete"];
    }
    [coder encodeObject:[self valueForKey:@"mutedUntilTimestampObsolete"] forKey:@"mutedUntilTimestampObsolete"];
    [coder encodeObject:[self valueForKey:@"shouldThreadBeVisible"] forKey:@"shouldThreadBeVisible"];
    [coder encodeObject:[self valueForKey:@"storyViewMode"] forKey:@"storyViewMode"];
}

- (nullable instancetype)initWithCoder:(NSCoder *)coder
{
    self = [super initWithCoder:coder];
    if (!self) {
        return self;
    }
    self->_conversationColorNameObsolete = [coder decodeObjectOfClass:[NSString class]
                                                               forKey:@"conversationColorNameObsolete"];
    self->_creationDate = [coder decodeObjectOfClass:[NSDate class] forKey:@"creationDate"];
    self->_editTargetTimestamp = [coder decodeObjectOfClass:[NSNumber class] forKey:@"editTargetTimestamp"];
    self->_isArchivedByLegacyTimestampForSorting =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"isArchivedByLegacyTimestampForSorting"] boolValue];
    self->_isArchivedObsolete = [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                                                 forKey:@"isArchivedObsolete"] boolValue];
    self->_isMarkedUnreadObsolete = [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                                                     forKey:@"isMarkedUnreadObsolete"] boolValue];
    self->_lastDraftInteractionRowId =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"lastDraftInteractionRowId"] unsignedLongLongValue];
    self->_lastDraftUpdateTimestamp =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"lastDraftUpdateTimestamp"] unsignedLongLongValue];
    self->_lastInteractionRowId =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class] forKey:@"lastInteractionRowId"] unsignedLongLongValue];
    self->_lastSentStoryTimestamp = [coder decodeObjectOfClass:[NSNumber class] forKey:@"lastSentStoryTimestamp"];
    self->_lastVisibleSortIdObsolete =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"lastVisibleSortIdObsolete"] unsignedLongLongValue];
    self->_lastVisibleSortIdOnScreenPercentageObsolete =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"lastVisibleSortIdOnScreenPercentageObsolete"] doubleValue];
    self->_mentionNotificationMode =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"mentionNotificationMode"] unsignedIntegerValue];
    self->_messageDraft = [coder decodeObjectOfClass:[NSString class] forKey:@"messageDraft"];
    self->_messageDraftBodyRanges = [coder decodeObjectOfClass:[MessageBodyRanges class]
                                                        forKey:@"messageDraftBodyRanges"];
    self->_mutedUntilDateObsolete = [coder decodeObjectOfClass:[NSDate class] forKey:@"mutedUntilDateObsolete"];
    self->_mutedUntilTimestampObsolete =
        [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                         forKey:@"mutedUntilTimestampObsolete"] unsignedLongLongValue];
    self->_shouldThreadBeVisible = [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                                                    forKey:@"shouldThreadBeVisible"] boolValue];
    self->_storyViewMode = [(NSNumber *)[coder decodeObjectOfClass:[NSNumber class]
                                                            forKey:@"storyViewMode"] unsignedIntegerValue];

    // renamed `hasEverHadMessage` -> `shouldThreadBeVisible`
    if (!_shouldThreadBeVisible) {
        NSNumber *_Nullable legacy_hasEverHadMessage = [coder decodeObjectForKey:@"hasEverHadMessage"];

        if (legacy_hasEverHadMessage != nil) {
            _shouldThreadBeVisible = legacy_hasEverHadMessage.boolValue;
        }
    }

    if (_conversationColorNameObsolete.length == 0) {
        _conversationColorNameObsolete = @"Obsolete";
    }

    NSDate *_Nullable lastMessageDate = [coder decodeObjectOfClass:NSDate.class forKey:@"lastMessageDate"];
    NSDate *_Nullable archivalDate = [coder decodeObjectOfClass:NSDate.class forKey:@"archivalDate"];
    _isArchivedByLegacyTimestampForSorting = [self.class legacyIsArchivedWithLastMessageDate:lastMessageDate
                                                                                archivalDate:archivalDate];

    if ([coder decodeObjectForKey:@"archivedAsOfMessageSortId"] != nil) {
        OWSAssertDebug(!_isArchivedObsolete);
        _isArchivedObsolete = YES;
    }

    return self;
}

- (NSUInteger)hash
{
    NSUInteger result = [super hash];
    result ^= self.conversationColorNameObsolete.hash;
    result ^= self.creationDate.hash;
    result ^= self.editTargetTimestamp.hash;
#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wdeprecated-declarations"
    result ^= self.isArchivedByLegacyTimestampForSorting;
#pragma clang diagnostic pop
    result ^= self.isArchivedObsolete;
    result ^= self.isMarkedUnreadObsolete;
    result ^= self.lastDraftInteractionRowId;
    result ^= self.lastDraftUpdateTimestamp;
    result ^= self.lastInteractionRowId;
    result ^= self.lastSentStoryTimestamp.hash;
    result ^= self.lastVisibleSortIdObsolete;
    result ^= @(self.lastVisibleSortIdOnScreenPercentageObsolete).stringValue.hash;
    result ^= self.mentionNotificationMode;
    result ^= self.messageDraft.hash;
    result ^= self.messageDraftBodyRanges.hash;
    result ^= self.mutedUntilDateObsolete.hash;
    result ^= self.mutedUntilTimestampObsolete;
    result ^= self.shouldThreadBeVisible;
    result ^= self.storyViewMode;
    return result;
}

- (BOOL)isEqual:(id)other
{
    if (![super isEqual:other]) {
        return NO;
    }
    TSThread *typedOther = (TSThread *)other;
    if (![NSObject isObject:self.conversationColorNameObsolete
              equalToObject:typedOther.conversationColorNameObsolete]) {
        return NO;
    }
    if (![NSObject isObject:self.creationDate equalToObject:typedOther.creationDate]) {
        return NO;
    }
    if (![NSObject isObject:self.editTargetTimestamp equalToObject:typedOther.editTargetTimestamp]) {
        return NO;
    }
#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wdeprecated-declarations"
    if (self.isArchivedByLegacyTimestampForSorting != typedOther.isArchivedByLegacyTimestampForSorting) {
        return NO;
    }
#pragma clang diagnostic pop
    if (self.isArchivedObsolete != typedOther.isArchivedObsolete) {
        return NO;
    }
    if (self.isMarkedUnreadObsolete != typedOther.isMarkedUnreadObsolete) {
        return NO;
    }
    if (self.lastDraftInteractionRowId != typedOther.lastDraftInteractionRowId) {
        return NO;
    }
    if (self.lastDraftUpdateTimestamp != typedOther.lastDraftUpdateTimestamp) {
        return NO;
    }
    if (self.lastInteractionRowId != typedOther.lastInteractionRowId) {
        return NO;
    }
    if (![NSObject isObject:self.lastSentStoryTimestamp equalToObject:typedOther.lastSentStoryTimestamp]) {
        return NO;
    }
    if (self.lastVisibleSortIdObsolete != typedOther.lastVisibleSortIdObsolete) {
        return NO;
    }
    if (self.lastVisibleSortIdOnScreenPercentageObsolete != typedOther.lastVisibleSortIdOnScreenPercentageObsolete) {
        return NO;
    }
    if (self.mentionNotificationMode != typedOther.mentionNotificationMode) {
        return NO;
    }
    if (![NSObject isObject:self.messageDraft equalToObject:typedOther.messageDraft]) {
        return NO;
    }
    if (![NSObject isObject:self.messageDraftBodyRanges equalToObject:typedOther.messageDraftBodyRanges]) {
        return NO;
    }
    if (![NSObject isObject:self.mutedUntilDateObsolete equalToObject:typedOther.mutedUntilDateObsolete]) {
        return NO;
    }
    if (self.mutedUntilTimestampObsolete != typedOther.mutedUntilTimestampObsolete) {
        return NO;
    }
    if (self.shouldThreadBeVisible != typedOther.shouldThreadBeVisible) {
        return NO;
    }
    if (self.storyViewMode != typedOther.storyViewMode) {
        return NO;
    }
    return YES;
}

- (id)copyWithZone:(nullable NSZone *)zone
{
    TSThread *result = [self copyAndAssignIdsWithZone:zone];
    result->_conversationColorNameObsolete = self.conversationColorNameObsolete;
    result->_creationDate = self.creationDate;
    result->_editTargetTimestamp = self.editTargetTimestamp;
#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wdeprecated-declarations"
    result->_isArchivedByLegacyTimestampForSorting = self.isArchivedByLegacyTimestampForSorting;
#pragma clang diagnostic pop
    result->_isArchivedObsolete = self.isArchivedObsolete;
    result->_isMarkedUnreadObsolete = self.isMarkedUnreadObsolete;
    result->_lastDraftInteractionRowId = self.lastDraftInteractionRowId;
    result->_lastDraftUpdateTimestamp = self.lastDraftUpdateTimestamp;
    result->_lastInteractionRowId = self.lastInteractionRowId;
    result->_lastSentStoryTimestamp = self.lastSentStoryTimestamp;
    result->_lastVisibleSortIdObsolete = self.lastVisibleSortIdObsolete;
    result->_lastVisibleSortIdOnScreenPercentageObsolete = self.lastVisibleSortIdOnScreenPercentageObsolete;
    result->_mentionNotificationMode = self.mentionNotificationMode;
    result->_messageDraft = [self.messageDraft copy];
    result->_messageDraftBodyRanges = self.messageDraftBodyRanges;
    result->_mutedUntilDateObsolete = self.mutedUntilDateObsolete;
    result->_mutedUntilTimestampObsolete = self.mutedUntilTimestampObsolete;
    result->_shouldThreadBeVisible = self.shouldThreadBeVisible;
    result->_storyViewMode = self.storyViewMode;
    return result;
}

- (void)anyDidInsertWithTransaction:(DBWriteTransaction *)transaction
{
    [super anyDidInsertWithTransaction:transaction];

    [ThreadAssociatedData createFor:self.uniqueId transaction:transaction];

    if (self.shouldThreadBeVisible && ![SSKPreferences hasSavedThreadWithTransaction:transaction]) {
        [SSKPreferences setHasSavedThread:YES transaction:transaction];
    }

    [self _anyDidInsertWithTx:transaction];

    [SSKEnvironment.shared.modelReadCachesRef.threadReadCache didInsertOrUpdateThread:self transaction:transaction];
}

- (void)anyDidUpdateWithTransaction:(DBWriteTransaction *)transaction
{
    [super anyDidUpdateWithTransaction:transaction];

    if (self.shouldThreadBeVisible && ![SSKPreferences hasSavedThreadWithTransaction:transaction]) {
        [SSKPreferences setHasSavedThread:YES transaction:transaction];
    }

    [SSKEnvironment.shared.modelReadCachesRef.threadReadCache didInsertOrUpdateThread:self transaction:transaction];

    [PinnedThreadManagerObjcBridge handleUpdatedThread:self transaction:transaction];
}

- (BOOL)isNoteToSelf
{
    return NO;
}

- (NSString *)colorSeed
{
    return self.uniqueId;
}

#pragma mark - To be subclassed.

- (NSArray<SignalServiceAddress *> *)recipientAddressesWithSneakyTransaction
{
    __block NSArray<SignalServiceAddress *> *recipientAddresses;
    [SSKEnvironment.shared.databaseStorageRef readWithBlock:^(
        DBReadTransaction *transaction) { recipientAddresses = [self recipientAddressesWithTransaction:transaction]; }];
    return recipientAddresses;
}


- (NSArray<SignalServiceAddress *> *)recipientAddressesWithTransaction:(DBReadTransaction *)transaction
{
    OWSAbstractMethod();

    return @[];
}

- (BOOL)hasSafetyNumbers
{
    return NO;
}

#pragma mark - Interactions

- (nullable TSInteraction *)lastInteractionForInboxWithTransaction:(DBReadTransaction *)transaction
{
    OWSAssertDebug(transaction);
    return [[[InteractionFinder alloc] initWithThreadUniqueId:self.uniqueId]
        mostRecentInteractionForInboxWithTransaction:transaction];
}

- (nullable TSInteraction *)firstInteractionAtOrAroundSortId:(uint64_t)sortId
                                                 transaction:(DBReadTransaction *)transaction
{
    OWSAssertDebug(transaction);
    return
        [[[InteractionFinder alloc] initWithThreadUniqueId:self.uniqueId] firstInteractionAtOrAroundSortId:sortId
                                                                                               transaction:transaction];
}

#pragma mark - Archival

+ (BOOL)legacyIsArchivedWithLastMessageDate:(nullable NSDate *)lastMessageDate
                               archivalDate:(nullable NSDate *)archivalDate
{
    if (!archivalDate) {
        return NO;
    }

    if (!lastMessageDate) {
        return YES;
    }

    return [archivalDate compare:lastMessageDate] != NSOrderedAscending;
}

#pragma mark - Merging

- (void)mergeFrom:(TSThread *)otherThread
{
    self.shouldThreadBeVisible = self.shouldThreadBeVisible || otherThread.shouldThreadBeVisible;
    self.lastInteractionRowId = MAX(self.lastInteractionRowId, otherThread.lastInteractionRowId);

    // Copy the draft if this thread doesn't have one. We always assign both
    // values if we assign one of them since they're related.
    if (self.messageDraft == nil) {
        self.messageDraft = otherThread.messageDraft;
        self.messageDraftBodyRanges = otherThread.messageDraftBodyRanges;
        self.lastDraftInteractionRowId = otherThread.lastDraftInteractionRowId;
        self.lastDraftUpdateTimestamp = otherThread.lastDraftUpdateTimestamp;
    }
}

@end

NS_ASSUME_NONNULL_END
